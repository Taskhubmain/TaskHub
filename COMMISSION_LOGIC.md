# Логика комиссий платформы

## Обзор

При завершении сделки и освобождении средств из эскроу, платформа взимает комиссию с суммы сделки. Размер комиссии зависит от типа сделки.

## Ставки комиссий

### 1. Заказы (Orders)
- **Комиссия:** 15% от суммы сделки
- **Исполнитель получает:** 85% от суммы сделки
- Применяется всегда, независимо от статуса "продвижения"

### 2. Объявления (Tasks)

#### 2.1. Обычные объявления
- **Комиссия:** 15% от суммы сделки
- **Исполнитель получает:** 85% от суммы сделки
- Применяется когда `is_boosted = false`

#### 2.2. Продвинутые объявления (Boosted)
- **Комиссия:** 25% от суммы сделки
- **Исполнитель получает:** 75% от суммы сделки
- Применяется когда `is_boosted = true`

## Техническая реализация

### База данных

1. **Таблица `deals`:**
   - `is_boosted` (boolean) - флаг продвинутого объявления, копируется из `tasks.is_boosted` при создании сделки
   - `platform_commission_rate` (numeric) - процент комиссии (15 или 25)
   - `platform_commission_amount` (numeric) - сумма комиссии в валюте сделки
   - `freelancer_payout_amount` (numeric) - сумма выплаты исполнителю

2. **Функция `release_escrow_to_freelancer`:**
   - Определяет тип сделки (order или task)
   - Для заказов: всегда 15%
   - Для объявлений: проверяет `is_boosted` (15% или 25%)
   - Списывает средства с эскроу
   - Начисляет чистую сумму на баланс исполнителя
   - Создает записи в `wallet_ledger` для выплаты и комиссии

### Клиентский код

При принятии предложения (`ProposalsPage.tsx`):
```typescript
const dealData = {
  // ... другие поля
  is_boosted: item.is_boosted || false  // Копируем из order/task
};
```

## Примеры расчетов

### Пример 1: Заказ на 1000 USD
- Сумма сделки: 1000 USD
- Комиссия (15%): 150 USD
- Выплата исполнителю: 850 USD

### Пример 2: Обычное объявление на 500 USD
- Сумма сделки: 500 USD
- Комиссия (15%): 75 USD
- Выплата исполнителю: 425 USD

### Пример 3: Продвинутое объявление на 500 USD
- Сумма сделки: 500 USD
- Комиссия (25%): 125 USD
- Выплата исполнителю: 375 USD

## Аудит

Все транзакции сохраняются в таблице `wallet_ledger`:
- Запись типа `escrow_release` - выплата исполнителю
- Запись типа `platform_commission` - комиссия платформы

Метаданные каждой записи содержат:
- `deal_id` - ID сделки
- `commission_rate` - ставка комиссии
- `commission_amount` - сумма комиссии
- `deal_type` - тип сделки (order/task)
- `is_boosted` - флаг продвижения
