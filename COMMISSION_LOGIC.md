# Логика комиссий платформы

## Обзор

При завершении сделки и освобождении средств из эскроу, платформа взимает комиссию с суммы сделки. Размер комиссии зависит от типа сделки.

## Ставки комиссий

### 1. Заказы (Orders)
- **Комиссия:** 15% от суммы сделки
- **Исполнитель получает:** 85% от суммы сделки
- Применяется всегда, независимо от статуса "продвижения"

### 2. Объявления (Tasks)

#### 2.1. Обычные объявления
- **Комиссия:** 15% от суммы сделки
- **Исполнитель получает:** 85% от суммы сделки
- Применяется когда `is_boosted = false`

#### 2.2. Продвинутые объявления (Boosted)
- **Комиссия:** 25% от суммы сделки
- **Исполнитель получает:** 75% от суммы сделки
- Применяется когда `is_boosted = true`

## Техническая реализация

### База данных

1. **Таблица `deals`:**
   - `is_boosted` (boolean) - флаг продвинутого объявления, копируется из `tasks.is_boosted` при создании сделки
   - `platform_commission_rate` (numeric) - процент комиссии (15 или 25)
   - `platform_commission_amount` (numeric) - сумма комиссии в валюте сделки
   - `freelancer_payout_amount` (numeric) - сумма выплаты исполнителю

2. **Функция `release_escrow_to_freelancer`:**
   - Определяет тип сделки (order или task)
   - Для заказов: всегда 15%
   - Для объявлений: проверяет `is_boosted` (15% или 25%)
   - Списывает средства с эскроу
   - **Начисляет чистую сумму на баланс исполнителя**:
     - Обновляет `profiles.balance` (основной баланс для UI)
     - Обновляет `wallets.balance` (для синхронизации)
     - Обновляет `wallets.total_earned` (статистика заработка)
   - Создает записи в `wallet_ledger` для выплаты и комиссии

3. **Таблицы балансов:**
   - `profiles.balance` - **основной источник истины**, используется в UI для отображения баланса
   - `wallets.balance` - дублирование для синхронизации и дополнительной статистики
   - `wallets.total_earned` - общая сумма заработанных средств
   - `wallets.total_withdrawn` - общая сумма выведенных средств

### Клиентский код

При принятии предложения (`ProposalsPage.tsx`):
```typescript
const dealData = {
  // ... другие поля
  is_boosted: item.is_boosted || false  // Копируем из order/task
};
```

## Примеры расчетов

### Пример 1: Заказ на 1000 USD
- Сумма сделки: 1000 USD
- Комиссия (15%): 150 USD
- Выплата исполнителю: 850 USD
- Обновляется: `profiles.balance += 850`, `wallets.balance += 850`, `wallets.total_earned += 850`

### Пример 2: Обычное объявление на 500 USD
- Сумма сделки: 500 USD
- Комиссия (15%): 75 USD
- Выплата исполнителю: 425 USD
- Обновляется: `profiles.balance += 425`, `wallets.balance += 425`, `wallets.total_earned += 425`

### Пример 3: Продвинутое объявление на 500 USD
- Сумма сделки: 500 USD
- Комиссия (25%): 125 USD
- Выплата исполнителю: 375 USD
- Обновляется: `profiles.balance += 375`, `wallets.balance += 375`, `wallets.total_earned += 375`

## Аудит

Все транзакции сохраняются в таблице `wallet_ledger`:
- Запись типа `escrow_release` - выплата исполнителю
- Запись типа `platform_commission` - комиссия платформы

Метаданные каждой записи содержат:
- `deal_id` - ID сделки
- `commission_rate` - ставка комиссии
- `commission_amount` - сумма комиссии
- `deal_type` - тип сделки (order/task)
- `is_boosted` - флаг продвижения

## Синхронизация балансов

После каждого освобождения средств из эскроу обновляются ОБЕ таблицы:

1. **profiles.balance** - используется везде в UI (WalletPage, ProfilePage, и т.д.)
2. **wallets.balance** - поддерживается в синхронизации с profiles
3. **wallets.total_earned** - увеличивается на сумму выплаты для статистики

Это гарантирует, что пользователь видит корректный баланс во всех частях приложения.

## Синхронизация при покупках

### Покупка откликов (BuyProposalsDialog)

При покупке дополнительных откликов:
1. Проверяется `profiles.balance` на достаточность средств
2. Обновляется `profiles.balance` (вычитается стоимость)
3. Обновляется `profiles.purchased_proposals` (добавляется количество)
4. **Синхронизируется `wallets.balance`** с новым значением
5. Создается запись в `wallet_ledger`:
   - `kind: 'purchase'`
   - `status: 'completed'`
   - `amount_minor: -цена * 100` (отрицательное значение)
   - `metadata`: информация о пакете

### Покупка подписки на рекомендации (SubscriptionPurchaseDialog)

При покупке подписки:
1. Проверяется `profiles.balance` на достаточность средств
2. Обновляется `profiles.balance` (вычитается стоимость)
3. **Синхронизируется `wallets.balance`** с новым значением
4. Создается запись в `recommendations_subscriptions`
5. Создается запись в `wallet_ledger`:
   - `kind: 'purchase'`
   - `status: 'completed'`
   - `amount_minor: -цена * 100` (отрицательное значение)
   - `metadata`: информация о плане

### Пополнение баланса (Stripe Webhook)

При успешной оплате через Stripe:
1. Обновляется `wallets.balance` (добавляется сумма)
2. Обновляется `wallets.total_earned` (добавляется сумма)
3. Обновляется `profiles.balance` (добавляется сумма)
4. Обновляется `transactions.status = 'completed'`

Все операции с балансом **синхронизируют обе таблицы** (`profiles` и `wallets`), гарантируя консистентность данных.
